# ============================================
# Quarkus Runner Base Container Configuration
# ============================================
# This builds the BASE container with all infrastructure
# App-specific containers will extend this base

# ============================================
# Container Basics
# ============================================
CONTAINER_VERSION="1"
CONTAINER_NAME_PREFIX="quarkus-runner-base"
BASE_IMAGE="images:debian/12"
BUILD_TYPE="base"  # base (this file) or app (for derived containers)

# ============================================
# JVM Configuration
# ============================================
JVM_DISTRIBUTION="openjdk"     # openjdk, graalvm, temurin
JVM_VERSION="21"
INSTALL_GRAALVM="false"        # Also install GraalVM for native builds
GRAALVM_VERSION="21.0.1"

# JVM Tools
INSTALL_MAVEN="true"
MAVEN_VERSION="3.9.6"
INSTALL_GRADLE="false"
GRADLE_VERSION="8.5"

# ============================================
# Quarkus Configuration
# ============================================
QUARKUS_VERSION="3.15.1"
QUARKUS_PLATFORM="io.quarkus.platform:quarkus-bom"
INSTALL_QUARKUS_CLI="true"

# Common Quarkus extensions (for reference, not pre-installed in base)
# Apps will bring their own dependencies
QUARKUS_EXTENSIONS_REFERENCE="resteasy-reactive,hibernate-orm-panache,smallrye-health,micrometer-registry-prometheus"

# ============================================
# Storage Configuration (MANDATORY)
# ============================================
STORAGE_PROVIDER="btrfs"
STORAGE_LOCATION_ID="btrfs_local_main"
STORAGE_QUOTA_SIZE="15G"       # Base container needs more space for tools
STORAGE_ROTATION_THRESHOLD="80"
STORAGE_COMPRESSION="true"
STORAGE_ENABLE_SNAPSHOTS="true"

# Application directories (created in base, used by apps)
APP_INSTALL_DIR="/opt/quarkus"
APP_DATA_DIR="/var/lib/quarkus"
APP_LOG_DIR="/var/log/quarkus"
APP_CONFIG_DIR="/etc/quarkus"
APP_SECRETS_DIR="/run/secrets"

# ============================================
# Memory & CPU Configuration
# ============================================
# Base container defaults (apps will override)
MEMORY_LIMIT="2GB"
MEMORY_SWAP_LIMIT="2GB"
CPU_LIMIT="2"

# JVM Memory settings (for base, apps override)
JVM_MIN_HEAP="512m"
JVM_MAX_HEAP="1536m"           # 75% of 2GB
JVM_METASPACE="256m"
JVM_MAX_METASPACE="512m"
JVM_GC_TYPE="G1"               # G1, ZGC, Shenandoah
JVM_EXTRA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"

# ============================================
# Network Configuration
# ============================================
NETWORK_BRIDGE="lxdbr0"
QUARKUS_HTTP_PORT="8080"
QUARKUS_HTTPS_PORT="8443"
DEBUG_PORT="5005"
METRICS_PORT="9000"
HEALTH_PORT="9000"

# Expose ports (apps will add their own)
EXPOSE_PORTS=""  # Base doesn't expose ports, apps do

# ============================================
# Logging Configuration
# ============================================
LOG_LEVEL="INFO"
LOG_FORMAT="json"              # json for Loki parsing
LOG_FILE_PATH="/var/log/quarkus/application.log"
LOG_MAX_FILE_SIZE="100MB"      # Rolling file size
LOG_MAX_BACKUP_COUNT="20"      # 100MB * 20 = 2GB max
LOG_RETENTION_MAX_SIZE="2G"    # Total max log storage (temporary - logs shipped to Loki)

# Note: Logs are temporary storage, shipped to Loki by Promtail and rotated
# Max retention = LOG_MAX_FILE_SIZE * LOG_MAX_BACKUP_COUNT

# Loki Integration (Promtail)
ENABLE_LOG_SHIPPING="true"
LOKI_ENDPOINT="http://grafana-loki-v.1:3100"
PROMTAIL_VERSION="2.9.4"
PROMTAIL_ENABLED="true"
PROMTAIL_SCRAPE_INTERVAL="5s"
LOG_LABELS="container=quarkus-runner-base,type=base"

# ============================================
# Monitoring & Health Checks
# ============================================
INSTALL_MONITORING="true"
HEALTH_CHECK_ENABLED="true"
METRICS_ENABLED="true"

# SmallRye Health endpoints (Quarkus standard)
HEALTH_ENDPOINT="/q/health/live"
READINESS_ENDPOINT="/q/health/ready"
METRICS_ENDPOINT="/q/metrics"

# ============================================
# Service Management
# ============================================
ENABLE_SYSTEMD_SERVICE="false"  # Base doesn't run app, apps will enable
INSTALL_SYSTEMD_TEMPLATE="true" # Install template for apps to use
AUTO_START_ON_BOOT="false"
RESTART_POLICY="on-failure"
RESTART_DELAY="10s"

# ============================================
# Development Tools (Optional)
# ============================================
INSTALL_DEV_TOOLS="true"
DEV_TOOLS="curl,wget,vim,net-tools,iputils-ping,git,unzip"

# ============================================
# Build Options
# ============================================
CLEAN_BUILD="true"             # Remove existing container
EXPORT_CONTAINER="true"        # Export as image for reuse
EXPORT_PATH="/tmp"
CREATE_SNAPSHOT="true"
START_SERVICES="false"         # Base container doesn't start services

# Publish as LXC image
PUBLISH_AS_IMAGE="true"
IMAGE_ALIAS="quarkus-runner-base"
IMAGE_DESCRIPTION="Quarkus runner base container with JVM 21, Maven, Promtail, and monitoring"

# ============================================
# Security
# ============================================
CREATE_QUARKUS_USER="true"     # Non-root user for running apps
QUARKUS_USER="quarkus"
QUARKUS_UID="1000"
QUARKUS_GID="1000"

# ============================================
# Database Drivers (Pre-installed in base)
# ============================================
INSTALL_DB_DRIVERS="true"
DB_DRIVERS="postgresql,mysql"  # Common drivers pre-installed

# ============================================
# Cache & Performance
# ============================================
MAVEN_CACHE_DIR="/var/cache/maven"
SETUP_MAVEN_CACHE="true"       # Pre-populate common dependencies

# ============================================
# Metadata
# ============================================
BUILD_DATE="$(date +%Y%m%d)"
MAINTAINER="orchestrix"
