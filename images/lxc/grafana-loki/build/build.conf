#!/bin/bash
# Build configuration for Grafana-Loki container
# All build parameters must be defined here

# ============================================
# BASE CONFIGURATION
# ============================================
BASE_IMAGE="images:debian/12"
CONTAINER_VERSION="1"
BUILD_TIMEOUT="1800"
CONTAINER_NAME_PREFIX="grafana-loki"

# ============================================
# STORAGE CONFIGURATION (MANDATORY)
# ============================================
# Storage provider (only btrfs currently supported)
STORAGE_PROVIDER="btrfs"

# Storage location ID (must exist in /etc/orchestrix/storage-locations.conf)
# REQUIRED - no default, must be specified
STORAGE_LOCATION_ID="btrfs_local_main"

# Container root directory name within storage
STORAGE_CONTAINER_ROOT="grafana-loki"

# Storage quota (REQUIRED - examples: 10G, 30G, 50G)
STORAGE_QUOTA_SIZE="4G"

# Enable compression
STORAGE_COMPRESSION="true"

# Snapshot configuration
STORAGE_SNAPSHOT_ENABLED="true"
STORAGE_SNAPSHOT_FREQUENCY="daily"
STORAGE_SNAPSHOT_RETAIN="7"

# ============================================
# SERVICE VERSIONS
# ============================================
GRAFANA_VERSION="10.2.3"
LOKI_VERSION="2.9.4"
PROMTAIL_VERSION="2.9.4"

# ============================================
# SERVICE PORTS
# ============================================
GRAFANA_PORT="3000"
LOKI_PORT="3100"
PROMTAIL_PORT="9080"

# ============================================
# LOG ROTATION AND RETENTION
# ============================================
# Enable log rotation
LOG_ROTATION_ENABLED="true"

# Loki retention period (h=hours, d=days)
LOKI_RETENTION_PERIOD="168h"  # 7 days default
LOKI_RETENTION_DELETE_DELAY="2h"
LOKI_COMPACTOR_ENABLED="true"

# System log rotation
SYSTEM_LOG_ROTATE_DAYS="7"
SYSTEM_LOG_COMPRESS="true"

# ============================================
# STORAGE THRESHOLD MONITORING
# ============================================
# Enable automatic rotation based on storage usage
STORAGE_MONITOR_ENABLED="true"

# Trigger rotation when storage reaches this percentage
STORAGE_ROTATION_THRESHOLD="80"

# Force aggressive cleanup at this threshold
STORAGE_FORCE_CLEANUP_THRESHOLD="90"

# Check interval in seconds
STORAGE_CHECK_INTERVAL="300"

# ============================================
# RESOURCE LIMITS
# ============================================
MEMORY_LIMIT="2GB"
CPU_LIMIT="2"

# ============================================
# NETWORK CONFIGURATION
# ============================================
NETWORK_BRIDGE="lxdbr0"
NETWORK_IP=""  # Empty for DHCP

# ============================================
# PACKAGE LISTS
# ============================================
PACKAGES_CORE="curl wget vim net-tools iputils-ping openssh-server sudo"

PACKAGES_SYSTEM="gnupg2 software-properties-common apt-transport-https ca-certificates logrotate"

PACKAGES_MONITORING=""  # Additional monitoring tools if needed

# ============================================
# SERVICE CONFIGURATION
# ============================================
ENABLE_SSH="true"
SSH_AUTO_ACCEPT="true"
SSH_PERMIT_ROOT="yes"
SSH_PASSWORD_AUTH="yes"

# ============================================
# GRAFANA CONFIGURATION
# ============================================
GRAFANA_ADMIN_USER="admin"
GRAFANA_ADMIN_PASSWORD="admin"
GRAFANA_FORCE_PASSWORD_CHANGE="true"

# ============================================
# LOKI CONFIGURATION
# ============================================
# Loki data directories
LOKI_DATA_DIR="/var/lib/loki"
LOKI_CONFIG_DIR="/etc/loki"
LOKI_CHUNKS_DIR="/var/lib/loki/chunks"
LOKI_RULES_DIR="/var/lib/loki/rules"

# Loki performance settings
LOKI_INGESTION_RATE_MB="10"
LOKI_INGESTION_BURST_MB="20"
LOKI_MAX_QUERY_LENGTH="721h"

# ============================================
# PROMTAIL CONFIGURATION
# ============================================
PROMTAIL_CONFIG_DIR="/etc/loki"
PROMTAIL_POSITIONS_FILE="/tmp/positions.yaml"
PROMTAIL_SCRAPE_INTERVAL="10s"

# ============================================
# BACKUP CONFIGURATION
# ============================================
BACKUP_ENABLED="true"
BACKUP_FREQUENCY="weekly"
BACKUP_RETENTION_WEEKS="4"

# ============================================
# BUILD OPTIONS
# ============================================
# Clean build (remove existing container)
CLEAN_BUILD="true"

# Export container after build
EXPORT_CONTAINER="true"
EXPORT_PATH="/tmp"

# Create snapshot after build
CREATE_SNAPSHOT="true"

# Start services after installation
START_SERVICES="true"

# ============================================
# DOWNLOAD URLS
# ============================================
GRAFANA_GPG_KEY="https://apt.grafana.com/gpg.key"
GRAFANA_APT_REPO="https://apt.grafana.com"

LOKI_BASE_URL="https://github.com/grafana/loki/releases/download"
LOKI_DOWNLOAD_URL="${LOKI_BASE_URL}/v${LOKI_VERSION}/loki-linux-amd64.zip"
PROMTAIL_DOWNLOAD_URL="${LOKI_BASE_URL}/v${PROMTAIL_VERSION}/promtail-linux-amd64.zip"