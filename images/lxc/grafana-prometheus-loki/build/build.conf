#!/bin/bash
#
# Build Configuration for Grafana-Prometheus-Loki Container
# Follows Orchestrix Container Scaffolding Standard v2.0
#
# All build parameters MUST be defined here
#

# ============================================
# BASE CONFIGURATION
# ============================================
BASE_IMAGE="images:debian/12"
CONTAINER_VERSION="1"
BUILD_TIMEOUT="1800"
CONTAINER_NAME_PREFIX="grafana-prometheus-loki"

# ============================================
# STORAGE CONFIGURATION (MANDATORY)
# ============================================
STORAGE_PROVIDER="btrfs"

# Storage location ID (REQUIRED - must exist in /etc/orchestrix/storage-locations.conf)
# Default: btrfs_local_main (adjust as needed)
STORAGE_LOCATION_ID="btrfs_local_main"

# Container root directory name within storage
STORAGE_CONTAINER_ROOT="grafana-prometheus-loki"

# Storage quota (REQUIRED - minimum 10G, recommended 30G for production)
STORAGE_QUOTA_SIZE="25G"

# Enable compression (recommended for logs)
STORAGE_COMPRESSION="true"

# Snapshot configuration
STORAGE_SNAPSHOT_ENABLED="true"
STORAGE_SNAPSHOT_FREQUENCY="daily"
STORAGE_SNAPSHOT_RETAIN="7"

# ============================================
# STORAGE MONITORING (MANDATORY)
# ============================================
STORAGE_MONITOR_ENABLED="true"

# Trigger rotation when storage reaches this percentage
STORAGE_ROTATION_THRESHOLD="80"

# Force aggressive cleanup at this threshold
STORAGE_FORCE_CLEANUP_THRESHOLD="90"

# Check interval in seconds
STORAGE_CHECK_INTERVAL="300"

# ============================================
# SERVICE VERSIONS
# ============================================
GRAFANA_VERSION="10.2.3"
LOKI_VERSION="2.9.4"
PROMTAIL_VERSION="2.9.4"
PROMETHEUS_VERSION="2.48.0"

# ============================================
# SERVICE PORTS (7000 range per guidelines)
# ============================================
GRAFANA_PORT="7300"
LOKI_PORT="7310"
PROMTAIL_PORT="7320"
PROMETHEUS_PORT="7330"

# ============================================
# LOG ROTATION AND RETENTION (MANDATORY)
# ============================================
LOG_ROTATION_ENABLED="true"

# Loki retention period (h=hours, d=days)
LOKI_RETENTION_PERIOD="720h"  # 30 days default
LOKI_RETENTION_DELETE_DELAY="2h"
LOKI_COMPACTOR_ENABLED="true"

# Prometheus retention
PROMETHEUS_RETENTION_TIME="30d"
PROMETHEUS_RETENTION_SIZE="15GB"

# System log rotation
SYSTEM_LOG_ROTATE_DAYS="7"
SYSTEM_LOG_COMPRESS="true"

# ============================================
# RESOURCE LIMITS
# ============================================
MEMORY_LIMIT="4GB"
CPU_LIMIT="4"

# ============================================
# NETWORK CONFIGURATION
# ============================================
NETWORK_BRIDGE="lxdbr0"
NETWORK_IP=""  # Empty for DHCP

# ============================================
# LOKI CONFIGURATION
# ============================================
# Loki data directories
LOKI_DATA_DIR="/var/lib/loki"
LOKI_CONFIG_DIR="/etc/loki"
LOKI_CHUNKS_DIR="/var/lib/loki/chunks"
LOKI_RULES_DIR="/var/lib/loki/rules"

# Loki performance settings
LOKI_INGESTION_RATE_MB="16"
LOKI_INGESTION_BURST_MB="32"
LOKI_MAX_QUERY_LENGTH="721h"

# ============================================
# PROMETHEUS CONFIGURATION
# ============================================
PROMETHEUS_DATA_DIR="/var/lib/prometheus"
PROMETHEUS_CONFIG_DIR="/etc/prometheus"
PROMETHEUS_SCRAPE_INTERVAL="15s"
PROMETHEUS_EVALUATION_INTERVAL="15s"

# ============================================
# PROMTAIL CONFIGURATION
# ============================================
PROMTAIL_CONFIG_DIR="/etc/loki"
PROMTAIL_POSITIONS_FILE="/tmp/positions.yaml"
PROMTAIL_SCRAPE_INTERVAL="10s"

# ============================================
# GRAFANA CONFIGURATION
# ============================================
GRAFANA_ADMIN_USER="admin"
GRAFANA_ADMIN_PASSWORD="admin"
GRAFANA_FORCE_PASSWORD_CHANGE="true"

# ============================================
# PACKAGE LISTS
# ============================================
PACKAGES_CORE="curl wget vim net-tools iputils-ping openssh-server sudo unzip"

PACKAGES_SYSTEM="gnupg2 software-properties-common apt-transport-https ca-certificates logrotate bc"

PACKAGES_MONITORING=""  # Additional monitoring tools if needed

# ============================================
# SERVICE CONFIGURATION
# ============================================
ENABLE_SSH="true"
SSH_AUTO_ACCEPT="true"
SSH_PERMIT_ROOT="yes"
SSH_PASSWORD_AUTH="yes"

# ============================================
# BUILD OPTIONS
# ============================================
# Clean build (remove existing container)
CLEAN_BUILD="true"

# Export container after build
EXPORT_CONTAINER="true"
EXPORT_PATH="/tmp"

# Create snapshot after build
CREATE_SNAPSHOT="true"

# Start services after installation
START_SERVICES="true"

# ============================================
# DOWNLOAD URLS
# ============================================
GRAFANA_GPG_KEY="https://apt.grafana.com/gpg.key"
GRAFANA_APT_REPO="https://apt.grafana.com"

LOKI_BASE_URL="https://github.com/grafana/loki/releases/download"
LOKI_DOWNLOAD_URL="${LOKI_BASE_URL}/v${LOKI_VERSION}/loki-linux-amd64.zip"
PROMTAIL_DOWNLOAD_URL="${LOKI_BASE_URL}/v${PROMTAIL_VERSION}/promtail-linux-amd64.zip"

PROMETHEUS_BASE_URL="https://github.com/prometheus/prometheus/releases/download"
PROMETHEUS_DOWNLOAD_URL="${PROMETHEUS_BASE_URL}/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-amd64.tar.gz"

# ============================================
# NOTES
# ============================================
# Storage Sizing Guide:
# - Development: 10-25GB
# - Small Production: 30-50GB
# - Medium Production: 50-100GB
# - Large Production: 100GB+
#
# Retention Period Examples:
# - 168h = 7 days
# - 720h = 30 days
# - 2160h = 90 days
#
