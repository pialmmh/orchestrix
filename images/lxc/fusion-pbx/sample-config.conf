#!/bin/bash
# Sample configuration for FusionPBX LXC container
# This file can be placed ANYWHERE in the filesystem
# Usage: ./launchFusionPBX.sh /path/to/this/config.conf

# ============================================
# REQUIRED CONFIGURATION
# ============================================

# Container name (must be unique)
CONTAINER_NAME="fusion-pbx-01"

# ============================================
# NETWORK CONFIGURATION
# ============================================

# LXD network to use (default: lxdbr0)
# This should be a bridge without NAT for VoIP
NETWORK="lxdbr0"

# Static IP address (optional)
# If not set, container will get DHCP IP
# Example: STATIC_IP="10.10.199.100"
STATIC_IP="10.10.199.100"

# ============================================
# BIND MOUNTS (Optional)
# ============================================
# Format: "host_path:container_path"
# Host paths can be absolute or use ~ for home directory
# Directories will be created if they don't exist

BIND_MOUNTS=(
    # Mount for persistent PostgreSQL data
    "~/fusion-pbx-data/postgresql:/var/lib/postgresql"
    
    # Mount for FreeSWITCH recordings and voicemail
    "~/fusion-pbx-data/recordings:/var/lib/freeswitch/recordings"
    
    # Mount for FreeSWITCH sounds
    "~/fusion-pbx-data/sounds:/usr/share/freeswitch/sounds"
    
    # Mount for backups
    "~/fusion-pbx-data/backups:/backups"
    
    # Mount for FreeSWITCH logs
    "~/fusion-pbx-data/logs:/var/log/freeswitch"
    
    # Development mounts (uncomment if needed)
    # "~/projects/fusionpbx:/var/www/fusionpbx"
    # "~/projects/freeswitch-config:/etc/freeswitch"
)

# ============================================
# FUSIONPBX CONFIGURATION
# ============================================

# Domain name for FusionPBX
DOMAIN_NAME="pbx.example.com"

# PostgreSQL password (will be set on first run)
DB_PASSWORD="SecureDBPassword123!"

# FusionPBX admin email for setup
ADMIN_EMAIL="admin@example.com"

# ============================================
# FREESWITCH SIP CONFIGURATION
# ============================================

# Internal SIP profile IP (usually same as container IP)
# This is used for phones registering to the PBX
SIP_INTERNAL_IP="10.10.199.100"

# External SIP profile IP (for SIP trunks)
# In bridge mode without NAT, this is usually the same as internal
SIP_EXTERNAL_IP="10.10.199.100"

# SIP domain (usually same as DOMAIN_NAME)
SIP_DOMAIN="pbx.example.com"

# RTP port range (default: 16384-32768)
RTP_START_PORT="16384"
RTP_END_PORT="32768"

# ============================================
# SERVICE CONFIGURATION
# ============================================

# Restart services after applying configuration
RESTART_SERVICES="true"

# Enable SIP debugging (generates large logs)
SIP_DEBUG="false"

# ============================================
# MONITORING (Optional)
# ============================================

# Monitor container startup logs after launch
MONITOR_STARTUP="false"

# ============================================
# ADVANCED OPTIONS (Optional)
# ============================================

# Base image name (default: fusion-pbx-base)
# Only change if you built a custom image
IMAGE_NAME="fusion-pbx-base"

# Memory limit (optional)
# Examples: "2GB", "4096MB"
# MEMORY_LIMIT="2GB"

# CPU limit (optional)
# Number of CPUs, can be decimal (e.g., "1.5")
# CPU_LIMIT="2"

# ============================================
# NOTES
# ============================================
# 
# 1. Network Architecture:
#    - No NAT between container and host (bridge mode)
#    - Perfect for VoIP applications (no NAT traversal issues)
#    - Container gets real IP on bridge network (10.10.199.0/24)
#    - Packets route: Container → Bridge → Host → Internet
#
# 2. First Time Setup:
#    Access: http://10.10.199.100/install.php
#    Database Settings:
#      - Database: PostgreSQL
#      - Host: localhost
#      - Port: 5432
#      - Name: fusionpbx
#      - Username: fusionpbx
#      - Password: [Use DB_PASSWORD from this config]
#    Create Admin Account:
#      - Username: admin
#      - Password: [Choose strong password]
#      - Email: [Use ADMIN_EMAIL from this config]
#
# 3. SIP Configuration:
#    Internal Profile (port 5060):
#      - For IP phones and softphones
#      - Listens on: 10.10.199.100:5060
#    External Profile (port 5080):
#      - For SIP trunks to providers
#      - Listens on: 10.10.199.100:5080
#    No NAT:
#      - Direct IP routing between containers
#      - No STUN/TURN needed
#      - RTP flows directly
#
# 4. Data Persistence:
#    All data in bind mounts survives container deletion:
#      - Database: ~/fusion-pbx-data/postgresql
#      - Recordings: ~/fusion-pbx-data/recordings
#      - Sounds: ~/fusion-pbx-data/sounds
#      - Logs: ~/fusion-pbx-data/logs
#
# 5. Access Methods:
#    Web UI: http://10.10.199.100
#    SSH: ssh fusionpbx@10.10.199.100 (password: fusion123)
#    Container Shell: lxc exec fusion-pbx-01 -- bash
#    FreeSWITCH CLI: lxc exec fusion-pbx-01 -- fs_cli
#    PostgreSQL: lxc exec fusion-pbx-01 -- psql -U postgres fusionpbx
#
# 6. Testing SIP:
#    From any SIP client:
#      - Server: 10.10.199.100
#      - Port: 5060
#      - Transport: UDP or TCP
#      - No STUN server needed
#
# 7. Management Commands:
#    Stop: lxc stop fusion-pbx-01
#    Start: lxc start fusion-pbx-01
#    Restart: lxc restart fusion-pbx-01
#    Delete: lxc delete fusion-pbx-01 --force
#    Logs: lxc exec fusion-pbx-01 -- journalctl -f
#
# 8. Troubleshooting:
#    Check services: lxc exec fusion-pbx-01 -- systemctl status freeswitch
#    SIP debug: lxc exec fusion-pbx-01 -- fs_cli -x "sofia global siptrace on"
#    View logs: lxc exec fusion-pbx-01 -- tail -f /var/log/freeswitch/freeswitch.log
#
# 9. Security Notes:
#    - Change default passwords immediately after setup
#    - Configure firewall rules on host if needed
#    - Use strong passwords for all accounts
#    - Consider TLS for SIP if exposed to internet
#
# 10. Config File Location:
#     This file can be placed ANYWHERE:
#       - /tmp/fusion.conf
#       - ~/configs/pbx.conf
#       - /opt/configs/fusion-pbx.conf
#     The launch script will find it: ./launchFusionPBX.sh /path/to/config.conf