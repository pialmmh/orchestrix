# Orchestrix Deployments

Per-tenant deployment configurations for WireGuard overlay and FRR BGP routing.

## Directory Structure

```
deployments/
├── netlab/                    # Test tenant
│   ├── common.conf           # Shared params (SSH, network, etc.)
│   ├── frr/                  # FRR BGP configs
│   │   ├── node1-config.conf
│   │   ├── node2-config.conf
│   │   └── node3-config.conf
│   ├── wireguard/            # WireGuard overlay configs
│   │   ├── node1.conf
│   │   ├── node2.conf
│   │   └── node3.conf
│   ├── output/               # Generated configs (gitignored)
│   │   ├── client1.conf      # Link3 office VPN
│   │   ├── client2.conf      # BDCOM server VPN
│   │   ├── clientN.conf      # Additional clients
│   │   ├── client.conf.example
│   │   └── README.md
│   └── README.md
│
├── telco-client-001/         # Example production tenant
│   ├── common.conf           # Shared params for this tenant
│   ├── frr/
│   │   └── [node configs...]
│   ├── wireguard/
│   │   └── [node configs...]
│   └── output/               # Generated outputs
│       └── [client configs...]
│
└── README.md                 # This file
```

## Organization Pattern

### Per-Tenant Structure
Each tenant/client gets their own directory with:
- **`common.conf`** - Shared parameters (SSH, network, deployment options)
- **`frr/`** - FRR BGP routing configurations (input)
- **`wireguard/`** - WireGuard overlay network configurations (input)
- **`output/`** - Generated configs and automation outputs (gitignored)
- **`README.md`** - Tenant-specific documentation (optional)

### Naming Convention
- **Tenant directories**: `tenant-name` or `client-name`
- **Node configs**: `node1-config.conf`, `node2-config.conf`, etc.
- Use consistent naming across frr/ and wireguard/ subdirectories

## Configuration Files

### Common Config (`common.conf`)
Shared parameters used across all automations for a tenant:

```bash
# Tenant info
TENANT_NAME="netlab"
ENVIRONMENT="test"

# SSH parameters (used by all deployments)
SSH_USER="telcobright"

# SSH authentication (choose one method):
SSH_PASSWORD_FILE="/path/to/password.txt"          # Method 1: Password file
# SSH_KEY_FILE="/path/to/ssh-key"                  # Method 2: SSH key file

# IMPORTANT: Never commit passwords directly!
# Add to .gitignore: *.password.txt

SSH_PORT="22"

# Node definitions
NODE1_IP="10.20.0.30"
NODE2_IP="10.20.0.31"
NODE3_IP="10.20.0.32"

# Network ranges
OVERLAY_NETWORK="10.9.9.0/24"
CONTAINER_SUPERNET="10.10.0.0/16"

# Deployment options
VERBOSE="true"
DRY_RUN="false"
```

**Benefits:**
- ✅ DRY principle - define once, use everywhere
- ✅ Centralized tenant configuration
- ✅ Easy to update SSH credentials for all nodes
- ✅ Consistent network parameters across automations
- ✅ Secure authentication (password file or SSH key)
- ✅ No hardcoded passwords in version control
- ✅ Password files can be gitignored

**SSH Authentication Methods:**

⚠️ **NEVER commit passwords directly in config files!**

1. **Password File** (for temporary/test use):
   ```bash
   SSH_PASSWORD_FILE="/secure/path/to/password.txt"

   # Create password file:
   echo "your_password" > /secure/path/password.txt
   chmod 600 /secure/path/password.txt

   # Add to .gitignore:
   echo "*.password.txt" >> .gitignore
   ```

2. **SSH Key File** (recommended for production):
   ```bash
   SSH_KEY_FILE="/secure/path/to/ssh-key"

   # Generate SSH key:
   ssh-keygen -t ed25519 -f /secure/path/ssh-key -N ""

   # Copy to remote:
   ssh-copy-id -i /secure/path/ssh-key.pub user@host
   ```

### FRR Configs (`frr/node*-config.conf`)
Shell variable format for FRR router deployment:

```bash
CONTAINER_NAME="frr-router-netlab01"
BASE_IMAGE="frr-router-base-v.1.0.0"
BGP_ASN="65199"
BGP_NEIGHBORS="10.9.9.2:65198,10.9.9.3:65197"
BGP_NETWORKS="10.10.199.0/24"
```

### WireGuard Configs (`wireguard/node*.conf`)
Standard WireGuard INI format:

```ini
[Interface]
PrivateKey = REPLACE_WITH_GENERATED_PRIVATE_KEY
Address = 10.9.9.1/24
ListenPort = 51820

[Peer]
PublicKey = REPLACE_WITH_PEER_PUBLIC_KEY
Endpoint = 10.20.0.31:51820
AllowedIPs = 10.9.9.2/32, 10.10.198.0/24
```

### Output Directory (`output/`)
Generated configurations and automation outputs:

```
output/
├── client1.conf              # VPN client config (Link3 office)
├── client2.conf              # VPN client config (BDCOM server)
├── clientN.conf              # Additional VPN clients
├── bgp-topology.txt          # Generated BGP topology
├── deployment-summary.txt    # Last deployment summary
├── client.conf.example       # Template for client configs
└── README.md                 # Output documentation
```

**⚠️ Security:** Output files contain private keys and are automatically gitignored.

**Generated by:**
- Java automation: `NetlabDeployment.java`, `WireGuardConfigGenerator.java`
- Shell scripts: `deploy-netlab.sh`

## Usage

### Deployment Automation
Reference configs from deployment scripts:

```bash
# Source common config first
source deployments/netlab/common.conf

# Method 1: Using password file
if [ -n "$SSH_PASSWORD_FILE" ] && [ -f "$SSH_PASSWORD_FILE" ]; then
  SSH_PASSWORD=$(cat "$SSH_PASSWORD_FILE")

  ./deploy-frr.sh \
    --host $NODE1_IP \
    --user $SSH_USER \
    --password "$SSH_PASSWORD" \
    --config deployments/netlab/frr/node1-config.conf
fi

# Method 2: Using SSH key file (recommended)
if [ -n "$SSH_KEY_FILE" ] && [ -f "$SSH_KEY_FILE" ]; then
  ./deploy-frr.sh \
    --host $NODE1_IP \
    --user $SSH_USER \
    --key-file "$SSH_KEY_FILE" \
    --config deployments/netlab/frr/node1-config.conf
fi

# Deploy WireGuard overlay
./deploy-wg.sh \
  --config deployments/netlab/wireguard/node1.conf \
  --target $NODE1_IP
```

### Java Automation
```java
// Load common config
String tenantDir = "deployments/netlab";
Map<String, String> commonConfig = loadShellConfig(tenantDir + "/common.conf");

// Use common params
String sshUser = commonConfig.get("SSH_USER");
String node1Ip = commonConfig.get("NODE1_IP");

// Handle SSH authentication methods
String sshPassword = commonConfig.get("SSH_PASSWORD");
String sshPasswordFile = commonConfig.get("SSH_PASSWORD_FILE");
String sshKeyFile = commonConfig.get("SSH_KEY_FILE");

// Load password from file if specified
if (sshPasswordFile != null && !sshPasswordFile.isEmpty()) {
    sshPassword = Files.readString(Path.of(sshPasswordFile)).trim();
}

// Create SSH connection
SSHConnection ssh;
if (sshKeyFile != null && !sshKeyFile.isEmpty()) {
    // Use SSH key authentication
    ssh = new SSHConnection(node1Ip, sshUser, sshKeyFile);
} else {
    // Use password authentication
    ssh = new SSHConnection(node1Ip, sshUser, sshPassword);
}

// Load automation-specific config
String frrConfigPath = tenantDir + "/frr/node1-config.conf";
FrrConfig config = FrrConfig.parseConfig(frrConfigPath);
```

## Adding New Tenant

1. **Create tenant directory:**
   ```bash
   mkdir -p deployments/new-client/{frr,wireguard,output}
   ```

2. **Copy common config template:**
   ```bash
   cp deployments/netlab/common.conf deployments/new-client/
   # Edit and customize for new client
   nano deployments/new-client/common.conf
   ```

3. **Copy automation configs:**
   ```bash
   cp deployments/netlab/frr/node1-config.conf deployments/new-client/frr/
   cp deployments/netlab/wireguard/node1.conf deployments/new-client/wireguard/
   ```

4. **Set up output directory:**
   ```bash
   cp deployments/netlab/output/README.md deployments/new-client/output/
   cp deployments/netlab/output/client.conf.example deployments/new-client/output/
   touch deployments/new-client/output/.gitkeep
   ```

5. **Customize for tenant:**
   - Update IPs, ASNs, network ranges in configs
   - Adjust container names
   - Modify peer configurations
   - Update SSH credentials in common.conf

6. **Document in tenant README:**
   ```bash
   echo "# New Client Deployment" > deployments/new-client/README.md
   ```

## Examples

### Netlab Test Environment
- **Tenant:** `netlab`
- **Nodes:** 3 VMs (netlab01/02/03)
- **Management:** 10.20.0.30-32
- **Overlay:** 10.9.9.1-3
- **Purpose:** Testing automation before production deployment

See: `deployments/netlab/README.md`

### Telco Client 001
- **Tenant:** `telco-client-001`
- **Nodes:** Production cluster
- **Purpose:** Production FRR + WireGuard deployment

## Best Practices

1. **One config per node** - Separate files for each deployment target
2. **Consistent naming** - Use same node names across frr/ and wireguard/
3. **Document tenant** - Include README.md in each tenant directory
4. **Version control** - Commit configs to track deployment history
5. **Template reuse** - Copy from netlab/ as starting point

## Related Documentation

- FRR Router Guide: `/images/containers/lxc/frr-router/DEPLOYMENT_GUIDE.md`
- Networking Guideline: `/images/networking_guideline_claude.md`
- WireGuard Config Generator: `/src/main/java/.../wireguard/WireGuardConfigGenerator.java`
- Deployment Example: `NETLAB_DEPLOYMENT_GUIDE.md`
