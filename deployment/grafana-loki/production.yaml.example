# Grafana-Loki Deployment Configuration
# Version: 1.0
# Copy this to: deployment/grafana-loki/v1.0/production.yaml

# ============================================
# SSH Configuration for Target Server
# ============================================
ssh:
  host: 10.255.246.175                # Target server IP/hostname
  port: 22                             # SSH port
  username: bdcom                      # SSH username
  password: ReBJxyd3kGDFW5Cm           # SSH password (or use keyPath)
  useKey: false                        # Set to true to use SSH key instead
  # keyPath: ~/.ssh/id_rsa             # Path to SSH private key (if useKey=true)

# ============================================
# Container Configuration (Follows Scaffolding Standard)
# ============================================
container:
  name: grafana-loki-prod             # Container name
  version: 1.0.0                       # Container version (matches images/lxc/grafana-loki/versions.conf)
  baseImage: images:debian/12          # Base image (Debian 12 - Bookworm)

# ============================================
# BTRFS Storage Configuration (MANDATORY)
# Per Container Scaffolding Standard v2.0
# ============================================
storage:
  provider: btrfs                      # MANDATORY: Must be btrfs
  path: /home/telcobright/btrfs        # Mount path for BTRFS filesystem
  quota: 30G                           # Container quota (required for BTRFS)

  # Loop device mode (file-based BTRFS)
  useLoopDevice: true                  # Create file-based BTRFS
  loopDeviceSize: 50G                  # Total BTRFS filesystem size
  loopDeviceImage: /opt/btrfs-logger.img  # Loop device file path

  # Storage monitoring (per scaffolding standard)
  monitoring:
    enabled: true                      # Enable automatic monitoring
    rotationThreshold: 80              # Rotate logs at 80% usage
    forceCleanupThreshold: 90          # Force cleanup at 90%
    checkInterval: 300                 # Check every 5 minutes

# ============================================
# Service Versions (Must Match Container Versions)
# Reference: images/lxc/grafana-loki/versions.conf
# ============================================
versions:
  grafana: "10.2.3"                   # Grafana version
  loki: "2.9.4"                       # Loki version
  promtail: "2.9.4"                   # Promtail version
  debian: bookworm                     # Debian version

# ============================================
# Service Ports
# ============================================
ports:
  grafana: 3000                        # Grafana web UI
  loki: 3100                           # Loki API
  promtail: 9080                       # Promtail metrics

# ============================================
# Network Configuration
# ============================================
network:
  bridge: lxdbr0                       # LXD bridge (will be created if needed)
  staticIP:                            # Static IP (empty = DHCP)
  # Example: 10.10.199.50/24

# ============================================
# Container Resources
# ============================================
resources:
  memory: 2GB                          # Memory limit
  cpu: 2                               # CPU cores

# ============================================
# Deployment Options
# ============================================
deployment:
  autoRollback: true                   # Rollback on failure
  skipValidation: false                # Run post-deployment validation
  interactive: false                   # Non-interactive mode
  buildTimeout: 600                    # Build timeout (seconds)
  launchTimeout: 120                   # Launch timeout (seconds)

  # Container build location reference
  containerPath: images/lxc/grafana-loki  # Relative to project root

# ============================================
# Validation Configuration
# ============================================
validation:
  # Services that must be running
  requiredServices:
    - grafana-server
    - loki
    - promtail

  # Ports that must be listening
  requiredPorts:
    - 3000  # Grafana
    - 3100  # Loki
    - 9080  # Promtail

  # Health check endpoints
  healthChecks:
    - name: grafana
      url: http://localhost:3000/api/health
      timeout: 10
    - name: loki
      url: http://localhost:3100/ready
      timeout: 10

# ============================================
# Log Rotation Configuration
# Per Container Scaffolding Standard
# ============================================
logging:
  rotation:
    enabled: true
    period: 168h                       # 7 days
    deleteDelay: 2h
    compactor: true
    maxLogSize: 100MB

# ============================================
# Advanced Options
# ============================================
advanced:
  # Use existing build script from container directory
  buildScript: images/lxc/grafana-loki/build/build.sh

  # Transfer mode (if deploying from different machine)
  transferScripts: false

  # LXD preseed (only if custom initialization needed)
  lxdPreseed: |
    config: {}
    networks:
    - name: lxdbr0
      type: bridge
      config:
        ipv4.address: auto
        ipv6.address: none
    storage_pools:
    - name: default
      driver: btrfs
      config:
        size: 50GB
    profiles:
    - name: default
      devices:
        eth0:
          name: eth0
          network: lxdbr0
          type: nic
        root:
          path: /
          pool: default
          type: disk

# ============================================
# Notes
# ============================================
# Structure follows: /home/mustafa/telcobright-projects/orchestrix
# - Container definition: images/lxc/grafana-loki/
# - Deployment configs: deployment/grafana-loki/v1.0/
# - Deployment script: scripts/deploy-grafana-loki.sh
#
# This configuration follows:
# - Container Scaffolding Standard v2.0
# - BTRFS mandatory storage requirements
# - Version management pattern
# - Orchestrix automation guidelines
