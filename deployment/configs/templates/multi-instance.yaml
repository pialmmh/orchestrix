# Multi-Instance Deployment Template
# For deploying multiple instances on the same server with different parameters

deployment:
  name: "${SERVICE_NAME}"
  version: "1.0"
  type: "multi-instance"
  environment: "${ENV}"
  description: "Multiple instances on single server"

artifact:
  type: "${ARTIFACT_TYPE}"  # binary|container
  name: "${ARTIFACT_NAME}"
  version: "${ARTIFACT_VERSION}"
  source: "database"
  artifact_id: "${DB_ARTIFACT_ID}"

targets:
  - server:
      host: "${TARGET_HOST}"
      user: "${DEPLOY_USER}"
      ssh_key: "${SSH_KEY_PATH}"
    instances:
      - name: "${SERVICE_NAME}-1"
        params:
          port: ${BASE_PORT}
          memory: "${MEMORY_LIMIT}"
          cpu: "${CPU_LIMIT}"
          node_id: "node-1"
          env_vars:
            INSTANCE_ID: "1"
            CLUSTER_PEERS: "[]"

      - name: "${SERVICE_NAME}-2"
        params:
          port: ${BASE_PORT + 10}
          memory: "${MEMORY_LIMIT}"
          cpu: "${CPU_LIMIT}"
          node_id: "node-2"
          env_vars:
            INSTANCE_ID: "2"
            CLUSTER_PEERS: '["127.0.0.1:${BASE_PORT}"]'

      - name: "${SERVICE_NAME}-3"
        params:
          port: ${BASE_PORT + 20}
          memory: "${MEMORY_LIMIT}"
          cpu: "${CPU_LIMIT}"
          node_id: "node-3"
          env_vars:
            INSTANCE_ID: "3"
            CLUSTER_PEERS: '["127.0.0.1:${BASE_PORT}", "127.0.0.1:${BASE_PORT + 10}"]'

monitoring:
  health_check_endpoints:
    - "http://${TARGET_HOST}:${BASE_PORT}/health"
    - "http://${TARGET_HOST}:${BASE_PORT + 10}/health"
    - "http://${TARGET_HOST}:${BASE_PORT + 20}/health"
  startup_timeout: 90
  check_interval: 10

rollback:
  enabled: true
  keep_versions: 3
  strategy: "all-or-nothing"  # all instances must succeed